<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    
    
    <title>编译原理学习笔记十-优化和目标代码生成 | 繁华落尽  如梦无痕</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="keywords" content="">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.2/dist/jquery.fancybox.min.css" />
    <link rel="stylesheet" href="/css/style.css?v=1.4.4">
    
    <script type="text/javascript">
        // Data Center
        var DC = {
            reward:	true,
            lv: JSON.parse('{"enable":false,"app_id":null,"app_key":null,"icon":true}'),
            v: JSON.parse('{"enable":false,"appid":null,"appkey":null,"notify":true,"verify":true,"placeholder":"give me some sugers plz...","avatar":"wavatar"}'),
            g: JSON.parse('{"enable":false,"lazy":true,"owner":"codefine","repo":"gitment","oauth":{"client_id":null,"client_secret":null},"perPage":10}'),
            d: JSON.parse('{"app_id":null}')
        };
    </script>
    <script type="text/javascript">
        window.lazyScripts=[];
    </script>
    
<meta name="generator" content="Hexo 4.2.0"></head>


<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="">
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap">
      
      <img src="/img/brand.jpg" class="brand-bg">
      
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">qk6665</h5>
          <a href="mailto:478649098@qq.com" title="478649098@qq.com" class="mail">
            
              <span>4</span>
            
              <span>7</span>
            
              <span>8</span>
            
              <span>6</span>
            
              <span>4</span>
            
              <span>9</span>
            
              <span>0</span>
            
              <span>9</span>
            
              <span>8</span>
            
              <span>@</span>
            
              <span>q</span>
            
              <span>q</span>
            
              <span>.</span>
            
              <span>c</span>
            
              <span>o</span>
            
              <span>m</span>
            
          </a>
        </hgroup>
        
        <ul class="menu-link">
          
              <li>
                <a href="https://github.com/qk6665" target="_blank">
                  <i class="icon icon-lg icon-github"></i>
                </a>
              </li>
            
        </ul>
        
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                首页
              </a>
            </li>
        
            <li class="">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                文章分类
              </a>
            </li>
        
            <li class="">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                标签
              </a>
            </li>
        
            <li class="">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                文章统计
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row clearfix">
        <a href="javascript:;" class="header-icon pull-left waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">
            <span>编译原理学习笔记十-优化和目标代码生成</span>
            
        </div>
        
        <a href="javascript:;" id="site_search_btn" class="header-icon pull-right waves-effect waves-circle waves-light">
            <i class="icon icon-lg icon-search"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">
    <img src="/img/banner2.jpg" class="header-bg">
    <div class="container fade-scale">
        <h1 class="title">编译原理学习笔记十-优化和目标代码生成</h1>
        <h5 class="subtitle">
            
                <time datetime="2020-05-05T13:45:43.000Z" itemprop="datePublished" class="page-time">
  2020-05-05
</time>


            
        </h5>
        
    </div>
    

</header>

<div id="site_search">
    <div class="search-title clearfix">
        <span class="pull-left">
          <i class="icon icon-lg icon-search"></i>
        </span>
        <input type="text" id="local-search-input" name="q" results="0" placeholder="search my blog..." class="form-control pull-left"/>
        <a href="javascript:;" class="close pull-right waves-effect waves-circle waves-light">
          <i class="icon icon-lg icon-close"></i>
        </a>
    </div>
    <div id="local-search-result"></div>
</div>


<div class="container body-wrap">
    <article id="post-编译原理学习笔记十-优化和目标代码生成"
  class="post-article article-type-post" itemprop="blogPost">
    <div class="post-card">
        <h1 class="post-card-title">编译原理学习笔记十-优化和目标代码生成</h1>
        <div class="post-meta">
            <time class="post-time" title="2020-05-05 21:45:43" datetime="2020-05-05T13:45:43.000Z"  itemprop="datePublished">2020-05-05</time>

            


            

            


            
        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            
            <h1 id="第十章-优化和目标代码生成"><a href="#第十章-优化和目标代码生成" class="headerlink" title="第十章 优化和目标代码生成"></a>第十章 优化和目标代码生成</h1><h3 id="第一部分：优化"><a href="#第一部分：优化" class="headerlink" title="第一部分：优化"></a>第一部分：优化</h3><h4 id="1-优化的基本概念"><a href="#1-优化的基本概念" class="headerlink" title="1 优化的基本概念"></a>1 优化的基本概念</h4><p>优化：对程序进行各种等价变换，使得从变换后的程序出发，可以生成更有效的目标代码。<br>优化的特点：等价，有效。<br>优化的级别：局部优化、循环优化、全局优化。<br>优化的种类：删除多余运算、合并已知量、复写传播、删除无用赋值、代码外提、强度消弱（例如乘法换为加法）、变换循环控制条件。</p>
<h4 id="2-局部优化"><a href="#2-局部优化" class="headerlink" title="2 局部优化"></a>2 局部优化</h4><p>局限于基本块范围内的优化称为基本块内的优化，或称局部优化。  </p>
<h5 id="2-1-基本块"><a href="#2-1-基本块" class="headerlink" title="2.1 基本块"></a>2.1 基本块</h5><p>基本块是程序中一顺序执行语句序列，其中只有一个入口和一个出口。入口就是其中第一个语句，出口就是其中最后一个语句。<br>对三地址语句为<code>x:=y+z</code>，称对x定值并引用y和z。<br>基本块中的一个名字在程序中的某个给定点是活跃的，是指如果在程序中(包括在本基本块或在其它基本块中)它的值在该点以后被引用。  </p>
<h5 id="2-2-基本块划分算法和流图"><a href="#2-2-基本块划分算法和流图" class="headerlink" title="2.2 基本块划分算法和流图"></a>2.2 基本块划分算法和流图</h5><p>划分基本块的算法：  </p>
<ol>
<li>找出中间语言(三地址语句)程序中各个基本块的入口语句:程序第一个语句，或能由条件转移语句或无条件转移语句转移到的语句，或紧跟在条件转移语句后面的语句；  </li>
<li>对以上求出的每个入口语句，确定其所属的基本块。它是由该入口语句到下一入口语句(不包括该入口语句)、或到一转移语句(包括该转移语句)、或一停语句(包括该停语句)之间的语句序列组成的；  </li>
<li>凡未被纳入某一基本块中的语句，可以从程序中删除。  </li>
</ol>
<p>流图：<br>以基本块为结点构成流图；<br>如果一个结点的基本块的入口语句是程序的第一条语句，则称此结点为首结点；<br>如果在某个执行顺序中，基本块B2紧接在基本块B1之后执行，则从B1到B2有一条有向边（B1是B2的前驱，B2是B1的后继）。有一个条件或无条件转移语句从B1的最后一条语句转移到B2的第一条语句；或者在程序的序列中，B2紧接在B1的后面，并且B1的最后一条语句不是一个无条件转移语句。  </p>
<p>示例：<br><a rel=编译原理学习笔记十-优化和目标代码生成 href="/2020/05/05/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E5%8D%81-%E4%BC%98%E5%8C%96%E5%92%8C%E7%9B%AE%E6%A0%87%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90/1.png" title="基本块划分和流图" data-fancybox="images"><img src="/2020/05/05/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E5%8D%81-%E4%BC%98%E5%8C%96%E5%92%8C%E7%9B%AE%E6%A0%87%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90/1.png" alt="基本块划分和流图"></a></p>
<h5 id="2-3-四元式的有向无环图-DAG-表示"><a href="#2-3-四元式的有向无环图-DAG-表示" class="headerlink" title="2.3 四元式的有向无环图(DAG)表示"></a>2.3 四元式的有向无环图(DAG)表示</h5><p>在DAG增加标记和附加信息：<br>图的叶结点以一标识符或常数作为标记，表示该结点代表该变量或常数的值；<br>图的内部结点以一运算符作为标记，表示该结点代表应用该运算符对其后继结点所代表的值进行运算的结果；<br>各个结点上可能附加一个或多个标识符(称附加标识符)表示这些变量具有该结点所代表的值。<br>示例：<br><a rel=编译原理学习笔记十-优化和目标代码生成 href="/2020/05/05/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E5%8D%81-%E4%BC%98%E5%8C%96%E5%92%8C%E7%9B%AE%E6%A0%87%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90/2.png" title="DAG的扩充" data-fancybox="images"><img src="/2020/05/05/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E5%8D%81-%E4%BC%98%E5%8C%96%E5%92%8C%E7%9B%AE%E6%A0%87%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90/2.png" alt="DAG的扩充"></a></p>
<p>四元式的DAG表示：<br><a rel=编译原理学习笔记十-优化和目标代码生成 href="/2020/05/05/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E5%8D%81-%E4%BC%98%E5%8C%96%E5%92%8C%E7%9B%AE%E6%A0%87%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90/3.png" title="四元式的DAG表示" data-fancybox="images"><img src="/2020/05/05/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E5%8D%81-%E4%BC%98%E5%8C%96%E5%92%8C%E7%9B%AE%E6%A0%87%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90/3.png" alt="四元式的DAG表示"></a></p>
<h5 id="2-4-局部优化算法"><a href="#2-4-局部优化算法" class="headerlink" title="2.4 局部优化算法"></a>2.4 局部优化算法</h5><p>一个基本块，可用一个DAG来表示，对基本块中每一条四元式代码，依次构造对应的DAG图，最后基本块中所有四元式构造出来DAG连成整个基本块的DAG。  </p>
<p>引入一个函数Node，保存和计算DAG中标识符与结点的对应关系：<br><a rel=编译原理学习笔记十-优化和目标代码生成 href="/2020/05/05/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E5%8D%81-%E4%BC%98%E5%8C%96%E5%92%8C%E7%9B%AE%E6%A0%87%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90/4.png" title="函数Node" data-fancybox="images"><img src="/2020/05/05/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E5%8D%81-%E4%BC%98%E5%8C%96%E5%92%8C%E7%9B%AE%E6%A0%87%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90/4.png" alt="函数Node"></a></p>
<p>步骤：  </p>
<ol>
<li><p>准备操作数的结点<br>1.1 如果NODE(B)无定义，则构造一标记为B的叶结点并定义NODE(B)为这个结点：<br>   如果当前四元式是0型，则记NODE(B)的值为n，转4；<br>   如果当前四元式是1型，则转2(1)；<br>   如果当前四元式是2型，则(i)如果NODE(C)无定义，则构造一标记为C的叶结点并定义NODE(C)为这个结点；(ii)转2(2)。  </p>
</li>
<li><p>合并已知量<br>2.1 如果NODE(B)是标记为常数的叶结点，则转2(3)；否则，转3(1)。<br>2.2 如果NODE(B)和NODE(C)都是标记为常数的叶结点，则转2(4)；否则，转3(2)。<br>2.3 执行op B (即合并已知量)。令得到的新常数为P。如果NODE(B)是处理当前四元式时新构造出来的结点，则删除它。如果NODE(P)无定义，则构造一用P作标记的叶结点n。置NODE(P)=n，转4。<br>2.4 执行B op C (即合并已知量)。令得到的新常数为P。如果NODE(B)或NODE(C)是处理当前四元式时新构造出来的结点，则删除它。如果NODE(P)无定义，则构造一用P作标记的叶结点n。置NODE(P)=n，转4。  </p>
</li>
<li><p>删除公共子表达式<br>3.1 检查DAG中是否已有一结点，其唯一后继为NODE(B)且标记为op(即公共子表达式)。如果没有，则构造该结点n，否则，把已有的结点作为它的结点并设该结点为n。转4。<br>3.2 检查DAG中是否已有一结点，其左后继为NODE(B)，右后继为NODE(C)，且标记为op(即公共子表达式)。如果没有，则构造该结点n，否则，把已有的结点作为它的结点并设该结点为n。转4。  </p>
</li>
<li><p>删除无用赋值<br>4.1 如果NODE(A)无定义，则把A附加在结点n上并令NODE(A)=n;否则，先把A从NODE(A)结点上的附加标识符集中删除(注意，如果NODE(A)是叶结点，则其A标记不删除)。把A附加到新结点n上并置NODE(A)=n。转处理下一四元式。  </p>
</li>
</ol>
<p>从DAG中得到的优化信息：<br>在基本块外被定值并在基本块内被引用的所有标识符，就是作为叶子结点上标记的那些标识符；<br>在基本块内被定值并且该值在基本块后面可以被引用的所有标识符，就是DAG各结点上的那些标记或者附加标识符。  </p>
<h4 id="3-循环优化"><a href="#3-循环优化" class="headerlink" title="3 循环优化"></a>3 循环优化</h4><p>可能反复执行的代码序列的优化称为循环优化。</p>
<h5 id="3-1-循环优化的措施"><a href="#3-1-循环优化的措施" class="headerlink" title="3.1 循环优化的措施"></a>3.1 循环优化的措施</h5><p>对循环中的代码，可以实行：<br>代码外提；<br>强度消弱；<br>删除归纳变量(变换循环控制条件)；<br>循环展开；<br>循环合并。  </p>
<h5 id="3-2-代码外提"><a href="#3-2-代码外提" class="headerlink" title="3.2 代码外提"></a>3.2 代码外提</h5><p>所谓变量A在某点d的定值到达另一点u（或称变量A的定值点d到达另一点u），是指流图中从d有一通路到达u且该通路上没有A的其它定值。<br>循环不变运算：对四元式A:=B op C,若B和C是常数，或者到达它们的B和C的定值点都在循环外；<br>把循环不变运算提到循环体外。  </p>
<p>查找循环中不变运算的算法：<br>依次查看L中各基本块的每个四元式，如果它的每个运算对象或为常数，或者定值点在 L外，则将此四元式标记为”不变运算”；<br>重复第3步直至没有新的四元式被标记为”不变运算”为止；<br>依次查看尚未被标记为”不变运算”的四元式，如果它的每个运算对象或为常数，或定值点在L之外，或只有一个到达-定值点且该点上的四元式已被标记为”不变运算”，则把被查看的四元式标记为”不变运算”。  </p>
<p><a rel=编译原理学习笔记十-优化和目标代码生成 href="/2020/05/05/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E5%8D%81-%E4%BC%98%E5%8C%96%E5%92%8C%E7%9B%AE%E6%A0%87%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90/5.png" title="代码外提" data-fancybox="images"><img src="/2020/05/05/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E5%8D%81-%E4%BC%98%E5%8C%96%E5%92%8C%E7%9B%AE%E6%A0%87%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90/5.png" alt="代码外提"></a></p>
<p>四元式S(A:=B OP C）外提的条件：  </p>
<ol>
<li>S所在的结点是L所有出口结点的必经结点；  </li>
<li>A在L中其他地方未再定值；   </li>
<li>L中所有A的引用点只有S中的A的定值才能到达。  </li>
</ol>
<p>或  </p>
<ol>
<li>A在离开L后不再是活跃的；  </li>
<li>A在L中其他地方未再定值；  </li>
<li>L中所有A的引用点只有S中的A的定值才能到达。  </li>
</ol>
<p>代码外提算法：  </p>
<ol>
<li>求出L的所有不变运算；  </li>
<li>对每个不变运算s:A:=B op C 或 A:=op B 或 A:=B检查是否满足外提的条件；  </li>
<li>按步骤1所找出不变运算的次序，依次把符合步骤2的条件(1)或(2)的不变运算s外提到L的前置结点中。但是，如果s的运算对象(B或C)是在L中定值的，那么，只有当这些定值四元式都已外提到前置结点中时，才能把s也外提到前置结点中。  </li>
</ol>
<h5 id="3-3-强度消弱"><a href="#3-3-强度消弱" class="headerlink" title="3.3 强度消弱"></a>3.3 强度消弱</h5><p>强度消弱是把程序中执行时间较长的运算转换为执行时间较短的运算。<br>强度消弱通常是针对循环控制变量有线性关系的变量赋值进行。<br>经过强度消弱后，循环中可能出现一些新的无用赋值。<br>对于消弱下标变量地址计算的强度非常有效。  </p>
<h5 id="3-4-删除归纳变量"><a href="#3-4-删除归纳变量" class="headerlink" title="3.4 删除归纳变量"></a>3.4 删除归纳变量</h5><p>如果循环中对变量I只有唯一的形如I:=I±C的赋值，且其中C为循环不变量，则称I为循环中的基本归纳变量；<br>如果I是循环中一基本归纳变量，J在循环中的定值总是可化归为I的同一线性函数，也即J=C1*I±C2，其中C1和C2都是循环不变量，则称J是归纳变量，并称它与I同族。基本归纳变量也是归纳变量。  </p>
<p>删除归纳变量在强度削弱以后进行，强度削弱和删除归纳变量的统一算法框架：  </p>
<ol>
<li>利用循环不变运算信息，找出循环中所有基本归纳变量。</li>
<li>找出所有其它归纳变量A，并找出A与已知基本归纳变量X的同族线性函数关系FA(X)。</li>
<li>对2中找出的每一归纳变量A，进行强度削弱。</li>
<li>删除对归纳变量的无用赋值。</li>
<li>删除基本归纳变量。如果基本归纳变量B在循环出口之后不是活跃的，并且在循环中，除在其自身的递归赋值中被引用外，只在形如 <code>if B rop Y goto L</code>的语句中被引用，则可选取一与B同族的归纳变量M来替换B进行条件控制。最后删除循环中对B的递归赋值的代码。</li>
</ol>
<h3 id="第二部分：目标代码生成"><a href="#第二部分：目标代码生成" class="headerlink" title="第二部分：目标代码生成"></a>第二部分：目标代码生成</h3><h4 id="4-目标代码生成器"><a href="#4-目标代码生成器" class="headerlink" title="4 目标代码生成器"></a>4 目标代码生成器</h4><p>任务：<br>把分析、翻译、优化后的中间代码变换成目标代码。  </p>
<p>输入：<br>源程序的中间表示，以及符号表中的信息；<br>类型检查。  </p>
<p>输出：<br>绝对指令代码：能够立即执行的机器语言代码，所有地址已经定位；<br>可重新定位指令代码：待装配的机器语言模块，执行时，由连接装配程序把它们和某些运行程序连接起来，转换成能执行的机器语言代码；<br>汇编指令代码：需要经过汇编程序转换成可执行的机器语言代码。  </p>
<h4 id="5-目标代码生成需要考虑的问题"><a href="#5-目标代码生成需要考虑的问题" class="headerlink" title="5 目标代码生成需要考虑的问题"></a>5 目标代码生成需要考虑的问题</h4><p>如何充分利用计算机的指令系统的特点；<br>如何充分利用计算机的寄存器，减少目标代码中访问存贮单元的次数。在寄存器分配期间，为程序的某一点选择驻留在寄存器中的一组变量；在随后的寄存器指派阶段，挑出变量将要驻留的具体寄存器。  </p>
<h4 id="6-目标机器模型"><a href="#6-目标机器模型" class="headerlink" title="6 目标机器模型"></a>6 目标机器模型</h4><p>一个抽象的计算机模型：<br>具有多个通用寄存器，可用作累加器和变址器；<br>运算必须在某个寄存器中进行；<br>含有四种类型的指令形式。</p>
<p>示例：<br><a rel=编译原理学习笔记十-优化和目标代码生成 href="/2020/05/05/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E5%8D%81-%E4%BC%98%E5%8C%96%E5%92%8C%E7%9B%AE%E6%A0%87%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90/6.png" title="代码外提" data-fancybox="images"><img src="/2020/05/05/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E5%8D%81-%E4%BC%98%E5%8C%96%E5%92%8C%E7%9B%AE%E6%A0%87%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90/6.png" alt="代码外提"></a>  </p>
<figure class="image-box">
                <a rel=编译原理学习笔记十-优化和目标代码生成 href="/2020/05/05/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E5%8D%81-%E4%BC%98%E5%8C%96%E5%92%8C%E7%9B%AE%E6%A0%87%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90/7.png" title="代码外提" data-fancybox="images"><img src="/2020/05/05/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E5%8D%81-%E4%BC%98%E5%8C%96%E5%92%8C%E7%9B%AE%E6%A0%87%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90/7.png" alt="代码外提" title class></a>
                <p>代码外提</p>
            </figure>  

<h4 id="7-带寄存器分配优化的代码生成"><a href="#7-带寄存器分配优化的代码生成" class="headerlink" title="7 带寄存器分配优化的代码生成"></a>7 带寄存器分配优化的代码生成</h4><p>以基本块为单位生成目标代码：<br>依次把四元式的中间代码变换成目标代码；<br>在基本块的范围内考虑如何充分利用寄存器；<br>进入基本块时，所有寄存器空闲；<br>离开基本块时，把存在寄存器中的现行的值存回主存中，释放所有寄存器；<br>不特别说明，所有说明变量在基本块出口之后均为非活跃变量。  </p>
<p>在一个基本块的范围内考虑充分利用寄存器：  </p>
<ol>
<li>要做到<br> 1.1 尽可能留：在生成计算某变量值的目标代码时，尽可能让该变量保留在寄存器中；<br> 1.2 尽可能用：后续的目标代码尽可能引用变量在寄存器中的值，而不访问内存；<br> 1.3 及时腾空：在离开基本块时，把存在寄存器中的现行的值放到主存中。  </li>
<li>要知道<br> 2.1 四元式指令：每条指令中各变量在将来会被使用的情况；<br> 2.2 变量：每个变量现行值的存放位置；<br> 2.3 寄存器：每个寄存器当前的使用状况。  </li>
</ol>
<h4 id="8-待用信息和活跃信息"><a href="#8-待用信息和活跃信息" class="headerlink" title="8 待用信息和活跃信息"></a>8 待用信息和活跃信息</h4><p>如果在一个基本块内，四元式i对A定值，四元式j要引用A值，而从i到j之间没有A的其他定值，那么，我们称j是四元式i的变量A的待用信息，即下一个引用点。<br>变量的符号表登记项中含有记录待用信息和活跃信息的栏。  </p>
<p>二元组(x, x)表示变量的待用信息和活跃信息：<br>第1元：i表示待用信息， ^表示非待用；<br>第2元：y表示活跃，^表示非活跃；<br>待用信息和活跃信息的变化(x，x)→(x，x)，用后者更新前者。</p>
<p>计算待用信息和活跃信息的算法：  </p>
<ol>
<li>把基本块中各变量的符号表中的待用信息栏填为“非待用”，并根据该变量在基本块出口之后是不是活跃的，把其中的活跃信息栏填为“活跃”或“非活跃”；  </li>
<li>从基本块出口到入口由后向前依次处理各个四元式i:A:=B op C：<br>2.1 把符号表中变量A的待用信息和活跃信息附加到四元式i上；<br>2.2 把符号表中A的待用信息和活跃信息分别置为“非待用”和“非活跃”；<br>2.3 把符号表中变量B和C的待用信息和活跃信息附加到四元式i上；<br>2.4 把符号表中B和C的待用信息均置为i，活跃信息均置为“活跃”.  </li>
</ol>
<h4 id="9-变量地址描述和寄存器描述"><a href="#9-变量地址描述和寄存器描述" class="headerlink" title="9 变量地址描述和寄存器描述"></a>9 变量地址描述和寄存器描述</h4><p>变量地址描述数组<code>AVALUE[A]={R1, R2, A}</code>：动态记录各变量现行值的存放位置。<br>寄存器描述数组<code>RVALUE[R]={A,B}</code>：动态记录各寄存器的使用信息。  </p>
<p>对于四元式A:=B，如果B的现行值在某寄存器Ri中，则无须生成目标代码，只须在RVALUE(Ri)中增加一个A，(即把Ri同时分配给B和A)，并把AVALUE(A)改为Ri。</p>
<h4 id="10-代码生成算法"><a href="#10-代码生成算法" class="headerlink" title="10 代码生成算法"></a>10 代码生成算法</h4><p>对每个四元式: i: A:=B op C，依次执行：  </p>
<ol>
<li>以四元式: i: A:=B op C 为参数，调用函数过程<code>GETREG(i: A:=B op C)</code>，返回一个寄存器R，用作存放A的寄存器。  </li>
<li>利用AVALUE[B]和AVALUE[C]，确定B和C现行值的存放位置B’和C’。如果其现行值在寄存器中，则把寄存器取作B’和C’。  </li>
<li>如果B’≠R，则生成目标代码：   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LD  R,  B’</span><br><span class="line">op  R,  C’</span><br></pre></td></tr></table></figure>
否则生成目标代码 <code>op R, C’</code>。如果B’或C’为R，则删除AVALUE[B]或AVALUE[C]中的R。  </li>
<li>令AVALUE[A]={R}, RVALUE[R]={A}。  </li>
<li>若B或C的现行值在基本块中不再被引用，也不是基本块出口之后的活跃变量，且其现行值在某寄存器Rk中，则删除RVALUE[Rk]中的B或C以及AVALUE[B]或AVALUE[C] 中的Rk ，使得该寄存器不再为B或C占用。  </li>
</ol>
<p>算法中，GETREG(i: A:=B op C) 返回一个用来存放A的值的寄存器。<br>寄存器分配算法：  </p>
<ol>
<li>(尽可能用B独占的寄存器)如果B的现行值在某个寄存器Ri中，RVALUE[Ri]中只包含B，此外，或者B与A是同一个标识符，或者B的现行值在执行四元式A:=B op C之后不会再引用，则选取Ri为所需要的寄存器R，并转4；  </li>
<li>(尽可能用空闲寄存器)如果有尚未分配的寄存器，则从中选取一个Ri为所需要的寄存器R，并转4；  </li>
<li>(抢占非空闲寄存器)从已分配的寄存器中选取一个Ri为所需要的寄存器R。最好使得Ri满足以下条件：占用Ri的变量的值也同时存放在该变量的贮存单元中，或者在基本块中要在最远的将来才会引用到或不会引用到。为Ri中的变量生成必要的存数指令；  </li>
<li>给出R，返回。</li>
</ol>
<p>寄存器分配算法第三步中，生成存数指令算法如下：<br>对RVALUE[Ri]中每一变量M，如果M不是A，或者如果M是A又是C，但不是B并且B也不在RVALUE[Ri]中，则：  </p>
<ol>
<li>如果AVALUE[M]不包含M，则生成目标代码 ST Ri，M；  </li>
<li>如果M是B，或者M是C但同时B也在RVALUE[Ri]中，则令AVALUE[M]={M， Ri} ，否则令AVALUE[M]={M}；  </li>
<li>删除RVALUE[Ri]中的M。  </li>
</ol>

        </div>
        
<blockquote class="post-copyright">
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2020-05-06T04:46:45.971Z" itemprop="dateUpdated">2020-05-06 12:46:45</time>
</span><br>


        
        转载请注明出处
        
    </div>
    <footer>
        <a href="https://qk6665.github.io">
            <img src="/img/avatar.jpg" alt="qk6665">
            qk6665
        </a>
    </footer>
</blockquote>

        
            <div class="page-reward">
    <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a>
</div>

            
        
        <div class="post-footer">
            
            <div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://qk6665.github.io/2020/05/05/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E5%8D%81-%E4%BC%98%E5%8C%96%E5%92%8C%E7%9B%AE%E6%A0%87%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90/&title=《编译原理学习笔记十-优化和目标代码生成》 — 繁华落尽  如梦无痕&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://qk6665.github.io/2020/05/05/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E5%8D%81-%E4%BC%98%E5%8C%96%E5%92%8C%E7%9B%AE%E6%A0%87%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《编译原理学习笔记十-优化和目标代码生成》 — 繁华落尽  如梦无痕&url=https://qk6665.github.io/2020/05/05/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E5%8D%81-%E4%BC%98%E5%8C%96%E5%92%8C%E7%9B%AE%E6%A0%87%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90/&via=https://qk6665.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>

        </div>
        
            


        
    </div>
    
<nav class="post-nav flex-row flex-justify-between flex-row-reverse">
  

  
    <div class="next">
      <a href="/2020/05/05/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%9D-%E7%A8%8B%E5%BA%8F%E8%BF%90%E8%A1%8C%E6%97%B6%E5%AD%98%E5%82%A8%E7%A9%BA%E9%97%B4%E7%9A%84%E7%BB%84%E7%BB%87/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">编译原理学习笔记九-程序运行时存储空间的组织</h4>
      </a>
    </div>
  
</nav>


    
    
        <aside class="post-widget">
            <nav class="post-toc-wrap" id="post-toc">
                <strong>目录</strong>
                <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#第十章-优化和目标代码生成"><span class="post-toc-text">第十章 优化和目标代码生成</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#第一部分：优化"><span class="post-toc-text">第一部分：优化</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#1-优化的基本概念"><span class="post-toc-text">1 优化的基本概念</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#2-局部优化"><span class="post-toc-text">2 局部优化</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#3-循环优化"><span class="post-toc-text">3 循环优化</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#第二部分：目标代码生成"><span class="post-toc-text">第二部分：目标代码生成</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-目标代码生成器"><span class="post-toc-text">4 目标代码生成器</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#5-目标代码生成需要考虑的问题"><span class="post-toc-text">5 目标代码生成需要考虑的问题</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#6-目标机器模型"><span class="post-toc-text">6 目标机器模型</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#7-带寄存器分配优化的代码生成"><span class="post-toc-text">7 带寄存器分配优化的代码生成</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#8-待用信息和活跃信息"><span class="post-toc-text">8 待用信息和活跃信息</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#9-变量地址描述和寄存器描述"><span class="post-toc-text">9 变量地址描述和寄存器描述</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#10-代码生成算法"><span class="post-toc-text">10 代码生成算法</span></a></li></ol></li></ol></li></ol></li></ol>
            </nav>
            <div class="toc-bar"><div>
        </aside>
    
</article>

    <div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        我们一起来让这个世界有趣一点
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/img/reward-wechat.jpg" alt="打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <input id="rewardToggle" type="checkbox" class="reward-toggle-check"
                data-wechat="/img/reward-wechat.jpg" data-alipay="/img/reward-alipay.jpg">
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-label"></span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>

    

</div>

    </main>
    <footer class="footer ">
    
    <div class="top">
        
            <p>
    <span>Links：</span>
    
    <span class="blogroll-item">
        <a href="https://qk6665.github.io/" target="_blank">HOME</a>
    </span>
    
    <span class="blogroll-item">
        <a href="https://github.com/qk6665" target="_blank">GITHUB</a>
    </span>
    
</p>

        
    </div>
    
    <div class="bottom">
        <p>
            <span>
                qk6665 &copy; 2020
            </span>
        		
           	
            
            
            
            

            
                
<span class="site-uv" title="总访客量">
    <i class="icon icon-user"></i>
    <i class="busuanzi-value" id="busuanzi_value_site_uv"></i>
</span>


<span class="site-pv" title="总访问量">
    <i class="icon icon-eye"></i>
    <i class="busuanzi-value" id="busuanzi_value_site_pv"></i>
</span>

            
        </p>
    </div>
</footer>

    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://qk6665.github.io/2020/05/05/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E5%8D%81-%E4%BC%98%E5%8C%96%E5%92%8C%E7%9B%AE%E6%A0%87%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90/&title=《编译原理学习笔记十-优化和目标代码生成》 — 繁华落尽  如梦无痕&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://qk6665.github.io/2020/05/05/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E5%8D%81-%E4%BC%98%E5%8C%96%E5%92%8C%E7%9B%AE%E6%A0%87%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《编译原理学习笔记十-优化和目标代码生成》 — 繁华落尽  如梦无痕&url=https://qk6665.github.io/2020/05/05/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E5%8D%81-%E4%BC%98%E5%8C%96%E5%92%8C%E7%9B%AE%E6%A0%87%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90/&via=https://qk6665.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,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" alt="微信分享二维码">
</div>


    
    <!-- main-js -->
<script type="text/javascript" src="//cdn.bootcss.com/jquery/2.1.0/jquery.min.js"></script>
<script type="text/javascript" src="/js/plugins/fastclick.js?v=1.4.4"></script>
<script type="text/javascript" src="/js/plugins/ios-orientationchange-fix.js?v=1.4.4"></script>
<script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.2/dist/jquery.fancybox.min.js"></script>

<script type="text/javascript" src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>

<script type="text/javascript" src="/js/method.js?v=1.4.4"></script>
<script type="text/javascript" src="/js/blog.js?v=1.4.4"></script>

<!-- third-party -->






<script type="text/javascript" src="/js/plugins/local_search.js?v=1.4.4"></script>
<script type="text/javascript">
	var search_path = "search.xml";
	if (search_path.length === 0) {
		search_path = "search.xml";
	}
	var path = "/" + search_path;
	searchFunc(path, "local-search-input", "local-search-result");
</script>



<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>



    
    





    <!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
            processEscapes: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>







    
</body>
</html>
