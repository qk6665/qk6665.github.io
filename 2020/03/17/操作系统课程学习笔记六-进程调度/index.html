<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    
    
    <title>操作系统课程学习笔记六-进程调度 | welcome to qk6665&#39;blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="keywords" content="">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.2/dist/jquery.fancybox.min.css" />
    <link rel="stylesheet" href="/css/style.css?v=1.4.4">
    
    <script type="text/javascript">
        // Data Center
        var DC = {
            reward:	true,
            lv: JSON.parse('{"enable":false,"app_id":null,"app_key":null,"icon":true}'),
            v: JSON.parse('{"enable":false,"appid":null,"appkey":null,"notify":true,"verify":true,"placeholder":"give me some sugers plz...","avatar":"wavatar"}'),
            g: JSON.parse('{"enable":false,"lazy":true,"owner":"codefine","repo":"gitment","oauth":{"client_id":null,"client_secret":null},"perPage":10}'),
            d: JSON.parse('{"app_id":null}')
        };
    </script>
    <script type="text/javascript">
        window.lazyScripts=[];
    </script>
    
<meta name="generator" content="Hexo 4.2.0"></head>


<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="">
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap">
      
      <img src="/img/brand.jpg" class="brand-bg">
      
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">qk6665</h5>
          <a href="mailto:478649098@qq.com" title="478649098@qq.com" class="mail">
            
              <span>4</span>
            
              <span>7</span>
            
              <span>8</span>
            
              <span>6</span>
            
              <span>4</span>
            
              <span>9</span>
            
              <span>0</span>
            
              <span>9</span>
            
              <span>8</span>
            
              <span>@</span>
            
              <span>q</span>
            
              <span>q</span>
            
              <span>.</span>
            
              <span>c</span>
            
              <span>o</span>
            
              <span>m</span>
            
          </a>
        </hgroup>
        
        <ul class="menu-link">
          
              <li>
                <a href="https://github.com/qk6665" target="_blank">
                  <i class="icon icon-lg icon-github"></i>
                </a>
              </li>
            
        </ul>
        
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                HOME
              </a>
            </li>
        
            <li class="">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                CATEGORIES
              </a>
            </li>
        
            <li class="">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                TAGS
              </a>
            </li>
        
            <li class="">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                ARCHIVES
              </a>
            </li>
        
            <li class="">
              <a href="/custom"  >
                <i class="icon icon-lg icon-plus-square"></i>
                CUSTOM
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row clearfix">
        <a href="javascript:;" class="header-icon pull-left waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">
            <span>操作系统课程学习笔记六-进程调度</span>
            
        </div>
        
        <a href="javascript:;" id="site_search_btn" class="header-icon pull-right waves-effect waves-circle waves-light">
            <i class="icon icon-lg icon-search"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">
    <img src="/img/banner.jpg" class="header-bg">
    <div class="container fade-scale">
        <h1 class="title">操作系统课程学习笔记六-进程调度</h1>
        <h5 class="subtitle">
            
                <time datetime="2020-03-17T05:30:56.000Z" itemprop="datePublished" class="page-time">
  2020-03-17
</time>


            
        </h5>
        
    </div>
    

</header>

<div id="site_search">
    <div class="search-title clearfix">
        <span class="pull-left">
          <i class="icon icon-lg icon-search"></i>
        </span>
        <input type="text" id="local-search-input" name="q" results="0" placeholder="search my blog..." class="form-control pull-left"/>
        <a href="javascript:;" class="close pull-right waves-effect waves-circle waves-light">
          <i class="icon icon-lg icon-close"></i>
        </a>
    </div>
    <div id="local-search-result"></div>
</div>


<div class="container body-wrap">
    <article id="post-操作系统课程学习笔记六-进程调度"
  class="post-article article-type-post" itemprop="blogPost">
    <div class="post-card">
        <h1 class="post-card-title">操作系统课程学习笔记六-进程调度</h1>
        <div class="post-meta">
            <time class="post-time" title="2020-03-17 13:30:56" datetime="2020-03-17T05:30:56.000Z"  itemprop="datePublished">2020-03-17</time>

            


            

            


            
        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            
            <h1 id="第六章-进程调度"><a href="#第六章-进程调度" class="headerlink" title="第六章 进程调度"></a>第六章 进程调度</h1><h4 id="5-1-进程调度的目标有哪些？"><a href="#5-1-进程调度的目标有哪些？" class="headerlink" title="5.1 进程调度的目标有哪些？"></a>5.1 进程调度的目标有哪些？</h4><p>响应速度尽可能快；<br>进程处理的时间尽可能短；<br>系统吞吐量尽可能大；<br>资源利用率尽可能高；<br>对所有进程要公平；<br>避免饥饿；<br>避免死锁。</p>
<h4 id="5-2-进程调度的7个目标中，你觉得windows或Linux重点在于满足哪些目标？为什么这么认为？"><a href="#5-2-进程调度的7个目标中，你觉得windows或Linux重点在于满足哪些目标？为什么这么认为？" class="headerlink" title="5.2 进程调度的7个目标中，你觉得windows或Linux重点在于满足哪些目标？为什么这么认为？"></a>5.2 进程调度的7个目标中，你觉得windows或Linux重点在于满足哪些目标？为什么这么认为？</h4><p>个人觉得与操作系统是linux还是windows关系不大，每种操作系统都有不同的版本用于不同的需求，如果偏向服务器会要求系统吞吐量、资源利用率高，如果偏向家庭办公的多任务交互场景会要求响应快、避免饥饿。windows有家庭版、工作站版等版本，linux也有很多版本，甚至可以自己修改内核。</p>
<h4 id="5-3-什么是周转时间，什么是带权周转时间？"><a href="#5-3-什么是周转时间，什么是带权周转时间？" class="headerlink" title="5.3 什么是周转时间，什么是带权周转时间？"></a>5.3 什么是周转时间，什么是带权周转时间？</h4><p>周转时间是指进程提交给计算机到最终用完成所花费的时间，说明了进程在系统中停留时间的长短。<br>带权周转时间是指进程的周转时间与运行时间的比值，说明了进程在系统的相对停留时间。</p>
<h4 id="5-4-什么是响应比？响应比高者优先调度算法有什么特点？"><a href="#5-4-什么是响应比？响应比高者优先调度算法有什么特点？" class="headerlink" title="5.4 什么是响应比？响应比高者优先调度算法有什么特点？"></a>5.4 什么是响应比？响应比高者优先调度算法有什么特点？</h4><p>响应比是指作业的响应时间与运行时间的比值，响应时间为等待时间加运行时间。<br>相同等待时间，运行时间越短的作业响应比越高；相同作业时间，等待时间越长的作业响应比越高。<br>响应比高者优先调度算法有利于短作业和等候长的作业。</p>
<h4 id="5-5-试述优先数调度的算法概念？何为静态优先数，何为动态优先数？"><a href="#5-5-试述优先数调度的算法概念？何为静态优先数，何为动态优先数？" class="headerlink" title="5.5 试述优先数调度的算法概念？何为静态优先数，何为动态优先数？"></a>5.5 试述优先数调度的算法概念？何为静态优先数，何为动态优先数？</h4><p>优先数调度算法根据进程的优先数，把CPU分配给最高的进程。<br>进程优先数等于静态优先数加动态优先数。<br>静态优先数在创建进程时确定，基于进程所需的资源多少、运行时间长短、进程类型(IO/CPU、前台/后台、核心/用户)。<br>动态优先数在进程运行期间可以改变，基于使用CPU时长、I/O操作、等待时长。</p>
<h4 id="5-6-静态优先数如何确定的？譬如：进程所需的资源多（或少），就分配较小（或较多）的静态优先数？"><a href="#5-6-静态优先数如何确定的？譬如：进程所需的资源多（或少），就分配较小（或较多）的静态优先数？" class="headerlink" title="5.6 静态优先数如何确定的？譬如：进程所需的资源多（或少），就分配较小（或较多）的静态优先数？"></a>5.6 静态优先数如何确定的？譬如：进程所需的资源多（或少），就分配较小（或较多）的静态优先数？</h4><p>1、进程所需的资源多，就分配较小的静态优先数，降低优先级，降低进程占用CPU时间；<br>2、基于程序运行时间的短，分配较多静态优先数，提高优先级，优先使用CPU；<br>3、进程的类型[IO/CPU,前台/后台,核心/用户]，核心进程分配较多优先数优先运行，用户进程分配优先数少排队运行。</p>
<h4 id="5-7-动态优先数如何确定的？譬如：当使用CPU超过一定时长时，就减少（或增加）的动态优先数？"><a href="#5-7-动态优先数如何确定的？譬如：当使用CPU超过一定时长时，就减少（或增加）的动态优先数？" class="headerlink" title="5.7 动态优先数如何确定的？譬如：当使用CPU超过一定时长时，就减少（或增加）的动态优先数？"></a>5.7 动态优先数如何确定的？譬如：当使用CPU超过一定时长时，就减少（或增加）的动态优先数？</h4><p>与静态优先数的理念相同，本质上都是在基于进程类型分配优先级，额外处理了静态优先级可能存在的饥饿现象。<br>1、当使用CPU超过一定时长时，就减少的动态优先数，降低进程优先级，目的是保证不阻碍其他IO任务的处理；<br>2、当进行I/O操作后，就增加的动态优先数，主观上认为这个进程可能与IO操作有关，日后大概率还会需要IO操作提高进程优先级进程I/O操作；<br>3、当进程等待超过一定时长时，就增加的动态优先数，处理了可能出现的饥饿现象。</p>
<h4 id="5-8-试述循环轮转调度的概念和其优点。"><a href="#5-8-试述循环轮转调度的概念和其优点。" class="headerlink" title="5.8 试述循环轮转调度的概念和其优点。"></a>5.8 试述循环轮转调度的概念和其优点。</h4><p>循环轮转调度是指把所有就绪进程按先进先出的原则排成队列，所有进程按时间片为单位轮流使用CPU，运行过但没结束的进程排队到队列末尾，等候下一轮运行。<br>该调度方式保证了进程调度的公平性和交互性。</p>
<h4 id="5-9-Linux创建子进程时，其COUNTER值为什么只继承父进程的一半，原因何在？"><a href="#5-9-Linux创建子进程时，其COUNTER值为什么只继承父进程的一半，原因何在？" class="headerlink" title="5.9 Linux创建子进程时，其COUNTER值为什么只继承父进程的一半，原因何在？"></a>5.9 Linux创建子进程时，其COUNTER值为什么只继承父进程的一半，原因何在？</h4><p>为保证进程调度的对所有进程要公平的原则。如果一个进程的子进程都按照父进程的COUNTER值继承，那该进程理论上可以通过无限创建子进程的方式长期占用CPU资源，不利于系统正常运行。</p>
<h4 id="5-10-描述Linux（以早期的0-11内核为参考）两个进程A-B切换的基本过程。"><a href="#5-10-描述Linux（以早期的0-11内核为参考）两个进程A-B切换的基本过程。" class="headerlink" title="5.10 描述Linux（以早期的0.11内核为参考）两个进程A,B切换的基本过程。"></a>5.10 描述Linux（以早期的0.11内核为参考）两个进程A,B切换的基本过程。</h4><p>进程切换时，首先是保护现场，中断程序调用了schedule()，其中的switch_to做了进程上下文切换，执行完毕后再恢复现场，中断返回。</p>
<p>进程切换switch_to()源代码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">/****************************************************************************/  </span><br><span class="line">/* 功能：切换到任务号（即task[]数组下标）为n的任务                          */  </span><br><span class="line">/* 参数：n 任务号                                                         */  </span><br><span class="line">/* 返回：（无）                                                               */  </span><br><span class="line">/****************************************************************************/  </span><br><span class="line">// 整个宏定义利用ljmp指令跳转到TSS段选择符来实现任务切换  </span><br><span class="line"><span class="comment">#define switch_to(n) &#123;/  </span></span><br><span class="line">// __tmp用来构造ljmp的操作数。该操作数由4字节偏移和2字节选择符组成。当选择符  </span><br><span class="line">// 是TSS选择符时，指令忽略4字节偏移。  </span><br><span class="line">// __tmp.a存放的是偏移，__tmp.b的低2字节存放TSS选择符。高两字节为0。  </span><br><span class="line">// ljmp跳转到TSS段选择符会造成任务切换到TSS选择符对应的进程。  </span><br><span class="line">// ljmp指令格式是 ljmp 16位段选择符：32位偏移，但如果操作数在内存中，顺序正好相反。  </span><br><span class="line">// %0   内存地址    __tmp.a的地址，用来放偏移  </span><br><span class="line">// %1   内存地址    __tmp.b的地址，用来放TSS选择符  </span><br><span class="line">// %2   edx         任务号为n的TSS选择符  </span><br><span class="line">// %3   ecx         task[n]  </span><br><span class="line">struct &#123;long a,b;&#125; __tmp; /  </span><br><span class="line">__asm__(<span class="string">"cmpl %%ecx,current/n/t"</span> /  // 如果要切换的任务是当前任务  </span><br><span class="line">    <span class="string">"je 1f/n/t"</span> /                   // 直接退出  </span><br><span class="line">    <span class="string">"movw %%dx,%1/n/t"</span> /            // 把TSS选择符放入__tmp.b中  </span><br><span class="line">    <span class="string">"xchgl %%ecx,current/n/t"</span> /     // 让current指向新进程的task_struct  </span><br><span class="line">    <span class="string">"ljmp *%0/n/t"</span> /                // 任务切换在这里发生，CPU会搞定一切  </span><br><span class="line">    <span class="string">"cmpl %%ecx,last_task_used_math/n/t"</span> /  // 除进程第一次被调度外，以后进程从就绪  </span><br><span class="line">                                        // 态返回运行态后，都从这里开始运行。因  </span><br><span class="line">                                        // 而返回到的是内核运行态。  </span><br><span class="line">    <span class="string">"jne 1f/n/t"</span> /  </span><br><span class="line">    <span class="string">"clts/n"</span> /  </span><br><span class="line">    <span class="string">"1:"</span> /  </span><br><span class="line">    ::<span class="string">"m"</span> (*&amp;__tmp.a),<span class="string">"m"</span> (*&amp;__tmp.b), /  </span><br><span class="line">    <span class="string">"d"</span> (_TSS(n)),<span class="string">"c"</span> ((long) task[n])); /  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主要流程是判断当前任务是否是要切换的任务，是则跳到标号1，即不做任何事；交换；调整等。。。</p>
<p>比较关键的是_TSS(n) 和ljmp %0。</p>
<p>第7行是理解任务切换机制的关键。长跳转至 <em>&amp;tmp，造成任务的切换。AT&amp;T语法的ljmp相当于Intel语法的 jmp far SECTION : OFFSET，在这里就是将（IP）&lt;-<strong>tmp.a,(CS)&lt;-</strong>tmp.b,它的绝对地址之前加星号（”</em>“）。当段间指令jmp所含指针的选择符指示一个可用任务状态段的TSS描述符时，将造成任务切换。那么CPU怎么识别描述符是TSS描述符而不是其他描述符呢？这是因为所有描述符（一个描述符是64位）中都有4位用来指示该描述符的类型，如描述符类型值是9或11都表示该描述符是TSS描述符。好了，CPU得到TSS描述符后，就会将其加载到任务寄存器TR中，然后根据TSS描述符的信息（主要是基址）找到任务的tss内容（包括所有的寄存器信息，如eip），根据其内容就可以开始新任务的运行。我们暂且把这个恢复所有寄存器状态的过程称为恢复寄存器现场。在第7行执行后，完成任务切换（即切换到新的任务里执行）；当任务切换回来后才会继续执行第8行！下面详解其原因。既然任务切换时CPU会恢复寄存器现场，那么它当然也会保存寄存器现场了。这些寄存器现场都会被写入原任务的tss结构里，值得注意的是，EIP会指向引起任务切换指令（第7行）的下一条指令（第8行），所以，很明显，当原任务有朝一日再次被调度运行时，它将从EIP所指的地方（第8行）开始运行。</p>
<p>​<figure class="image-box">
                <a rel=操作系统课程学习笔记六-进程调度 href="/2020/03/17/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E5%85%AD-%E8%BF%9B%E7%A8%8B%E8%B0%83%E5%BA%A6/1.png" title="ljmp %0" data-fancybox="images"><img src="/2020/03/17/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E5%85%AD-%E8%BF%9B%E7%A8%8B%E8%B0%83%E5%BA%A6/1.png" alt="ljmp %0" title class></a>
                <p>ljmp %0</p>
            </figure></p>
<h4 id="5-11-描述Linux（以早期的0-11内核为参考）中普通进程的调度过程。"><a href="#5-11-描述Linux（以早期的0-11内核为参考）中普通进程的调度过程。" class="headerlink" title="5.11 描述Linux（以早期的0.11内核为参考）中普通进程的调度过程。"></a>5.11 描述Linux（以早期的0.11内核为参考）中普通进程的调度过程。</h4><p>linux系统中，一个进程有5种可能状态，在sched.c第19行处定义了状态的标识：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#define TASK_RUNNING 0 // 正在运行或可被运行状态</span></span><br><span class="line"><span class="comment">#define TASK_INTERRUPTIBLE 1 // 可被中断睡眠状态</span></span><br><span class="line"><span class="comment">#define TASK_UNINTERRUPTIBLE 2 // 不可中断睡眠状态</span></span><br><span class="line"><span class="comment">#define TASK_ZOMBIE 3 // 僵死状态</span></span><br><span class="line"><span class="comment">#define TASK_STOPPED 4 // 停止状态</span></span><br></pre></td></tr></table></figure>
<p>各种状态的转换图如下：</p>
<p>​<figure class="image-box">
                <a rel=操作系统课程学习笔记六-进程调度 href="/2020/03/17/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E5%85%AD-%E8%BF%9B%E7%A8%8B%E8%B0%83%E5%BA%A6/2.png" title="状态的转换图" data-fancybox="images"><img src="/2020/03/17/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E5%85%AD-%E8%BF%9B%E7%A8%8B%E8%B0%83%E5%BA%A6/2.png" alt="状态的转换图" title class></a>
                <p>状态的转换图</p>
            </figure></p>
<p>普通进程的调度发生在用户态。当时钟中断产生时，如果进程运行在用户态时并且时间片用完，中断处理函数do_timer()会调用schedule()函数，这相当于用户态的运行被抢断了。如果进程处在内核态时发生时钟中断，do_timer()不会调用schedule()函数，也就是内核态是不能被抢断的。当一个进程运行在内核态，除非它自愿调用schedule()函数而放弃CPU的使用权，它将永远占用CPU。由于schedule()不是系统调用，用户程序不能调用，所以在时钟中断中调用schedule()是必要的，这样保证用户态的程序不会独占CPU。</p>
<p>schedule()函数代码如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">/****************************************************************************/  </span><br><span class="line">/* 功能：进程调度。                                                         */  </span><br><span class="line">/*       先对alarm和信号进行处理，如果某个进程处于可中断睡眠状态，并且收 */  </span><br><span class="line">/*       到信号，则把进程状态改成可运行。之后在处可运行状态的进程中挑选一个  */  </span><br><span class="line">/*       并用switch_to()切换到那个进程                                       */  </span><br><span class="line">/* 参数：（无）                                                               */  </span><br><span class="line">/* 返回：（无）                                                               */  </span><br><span class="line">/****************************************************************************/  </span><br><span class="line">void schedule(void)  </span><br><span class="line">&#123;  </span><br><span class="line">    int i,next,c;  </span><br><span class="line">    struct task_struct ** p;  </span><br><span class="line">/* check alarm, wake up any interruptible tasks that have got a signal */  </span><br><span class="line">// 首先处理alarm信号，唤醒所有收到信号的可中断睡眠进程  </span><br><span class="line">    <span class="keyword">for</span>(p = &amp;LAST_TASK ; p &gt; &amp;FIRST_TASK ; --p)  </span><br><span class="line">        <span class="keyword">if</span> (*p) &#123;  </span><br><span class="line">            // 如果进程设置了alarm，并且alarm已经到时间了  </span><br><span class="line">            <span class="keyword">if</span> ((*p)-&gt;alarm &amp;&amp; (*p)-&gt;alarm &lt; jiffies) &#123;  </span><br><span class="line">                    // 向该进程发送SIGALRM信号  </span><br><span class="line">                    (*p)-&gt;signal |= (1&lt;&lt;(SIGALRM-1));  </span><br><span class="line">                    (*p)-&gt;alarm = 0; // 清除alarm  </span><br><span class="line">                &#125;  </span><br><span class="line">//可屏蔽信号位图BLOCKABLE定义在sched.c第24行，(~(_S(SIGKILL) | _S(SIGSTOP)))  </span><br><span class="line">// 说明SIGKILL和SIGSTOP是不能被屏蔽的。  </span><br><span class="line">// 可屏蔽信号位图 &amp; 当前进程屏蔽的信号位图 = 当前进程实际屏蔽的信号位图  </span><br><span class="line">// 当前进程收到的信号位图 &amp; ~当前进程实际屏蔽的信号位图   </span><br><span class="line">//                          = 当前进程收到的允许相应的信号位图  </span><br><span class="line">// 如果当前进程收到允许相应的信号，并且当前进程处于可中断睡眠态  </span><br><span class="line">// 则把状态改成运行态，参与下面的选择过程  </span><br><span class="line">            <span class="keyword">if</span> (((*p)-&gt;signal &amp; ~(_BLOCKABLE &amp; (*p)-&gt;blocked)) &amp;&amp;  </span><br><span class="line">            (*p)-&gt;state==TASK_INTERRUPTIBLE)  </span><br><span class="line">                (*p)-&gt;state=TASK_RUNNING;  </span><br><span class="line">        &#125;  </span><br><span class="line">/* this is the scheduler proper: */  </span><br><span class="line">// 下面是进程调度的主要部分  </span><br><span class="line">    <span class="keyword">while</span> (1) &#123;  </span><br><span class="line">        c = -1;  </span><br><span class="line">        next = 0;  </span><br><span class="line">        i = NR_TASKS;  </span><br><span class="line">        p = &amp;task[NR_TASKS];  </span><br><span class="line">        <span class="keyword">while</span> (--i) &#123;       // 遍历整个task[]数组  </span><br><span class="line">            <span class="keyword">if</span> (!*--p)      // 跳过task[]中的空项  </span><br><span class="line">                <span class="built_in">continue</span>;  </span><br><span class="line">            // 寻找剩余时间片最长的可运行进程，  </span><br><span class="line">//  c记录目前找到的最长时间片  </span><br><span class="line">// next记录目前最长时间片进程的任务号  </span><br><span class="line">            <span class="keyword">if</span> ((*p)-&gt;state == TASK_RUNNING &amp;&amp; (*p)-&gt;counter &gt; c)  </span><br><span class="line">                c = (*p)-&gt;counter, next = i;  </span><br><span class="line">        &#125;  </span><br><span class="line">    // 如果有进程时间片没有用完c一定大于0。这时退出循环，执行 switch_to任务切换  </span><br><span class="line">        <span class="keyword">if</span> (c) <span class="built_in">break</span>;  </span><br><span class="line">    // 到这里说明所有可运行进程的时间片都用完了，则利用任务优先级重新分配时间片。  </span><br><span class="line">    // 这里需要重新设置所有任务的时间片，而不光是可运行任务的时间片。  </span><br><span class="line">    // 利用公式：counter = counter/2 + priority  </span><br><span class="line">        <span class="keyword">for</span>(p = &amp;LAST_TASK ; p &gt; &amp;FIRST_TASK ; --p)  </span><br><span class="line">            <span class="keyword">if</span> (*p)  </span><br><span class="line">                (*p)-&gt;counter = ((*p)-&gt;counter &gt;&gt; 1) +  </span><br><span class="line">                        (*p)-&gt;priority;  </span><br><span class="line">    // 整个设置时间片过程结束后，重新进入进程选择过程  </span><br><span class="line">    &#125;  </span><br><span class="line">    // 当的上面的循环退出时，说明找到了可以切换的任务  </span><br><span class="line">    switch_to(next);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当前进程只有调用了schedule()后才能发生进程切换，因此当进程再次被选中执行后，都是从switch_to()中ljmp后一条语句开始执行，即从”cmpl %%ecx,last_task_used_math/n/t”语句继续，这时进程位于内核态。因此进程从就绪态进入的都是内核运行态。但有一个例外，进程产生后第一次被调度执行。</p>
<p>fork()产生的子进程会把父进程原cs、原eip当作初始的cs、eip，所以子进程刚刚创建时处于用户态。第一次进程被调度时，从就绪态进入的是用户运行态。以后进入的都是内核运行态。</p>

        </div>
        
<blockquote class="post-copyright">
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2020-03-17T07:50:25.722Z" itemprop="dateUpdated">2020-03-17 15:50:25</time>
</span><br>


        
        转载注明出处，原文地址：<a href="/2020/03/17/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E5%85%AD-%E8%BF%9B%E7%A8%8B%E8%B0%83%E5%BA%A6/" target="_blank" rel="external">http://yoursite.com/2020/03/17/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E5%85%AD-%E8%BF%9B%E7%A8%8B%E8%B0%83%E5%BA%A6/</a>
        
    </div>
    <footer>
        <a href="http://yoursite.com">
            <img src="/img/avatar.jpg" alt="qk6665">
            qk6665
        </a>
    </footer>
</blockquote>

        
            <div class="page-reward">
    <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a>
</div>

            
        
        <div class="post-footer">
            
            <div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://yoursite.com/2020/03/17/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E5%85%AD-%E8%BF%9B%E7%A8%8B%E8%B0%83%E5%BA%A6/&title=《操作系统课程学习笔记六-进程调度》 — welcome to qk6665'blog&pic=http://yoursite.com/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://yoursite.com/2020/03/17/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E5%85%AD-%E8%BF%9B%E7%A8%8B%E8%B0%83%E5%BA%A6/&title=《操作系统课程学习笔记六-进程调度》 — welcome to qk6665'blog&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>

        </div>
        
            


        
    </div>
    
<nav class="post-nav flex-row flex-justify-between flex-row-reverse">
  

  
    <div class="next">
      <a href="/2020/03/17/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%BA%94-%E6%AD%BB%E9%94%81/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">操作系统课程学习笔记五-死锁</h4>
      </a>
    </div>
  
</nav>


    
    
        <aside class="post-widget">
            <nav class="post-toc-wrap" id="post-toc">
                <strong>目录</strong>
                <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#第六章-进程调度"><span class="post-toc-number">1.</span> <span class="post-toc-text">第六章 进程调度</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#5-1-进程调度的目标有哪些？"><span class="post-toc-number">1.0.0.1.</span> <span class="post-toc-text">5.1 进程调度的目标有哪些？</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#5-2-进程调度的7个目标中，你觉得windows或Linux重点在于满足哪些目标？为什么这么认为？"><span class="post-toc-number">1.0.0.2.</span> <span class="post-toc-text">5.2 进程调度的7个目标中，你觉得windows或Linux重点在于满足哪些目标？为什么这么认为？</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#5-3-什么是周转时间，什么是带权周转时间？"><span class="post-toc-number">1.0.0.3.</span> <span class="post-toc-text">5.3 什么是周转时间，什么是带权周转时间？</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#5-4-什么是响应比？响应比高者优先调度算法有什么特点？"><span class="post-toc-number">1.0.0.4.</span> <span class="post-toc-text">5.4 什么是响应比？响应比高者优先调度算法有什么特点？</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#5-5-试述优先数调度的算法概念？何为静态优先数，何为动态优先数？"><span class="post-toc-number">1.0.0.5.</span> <span class="post-toc-text">5.5 试述优先数调度的算法概念？何为静态优先数，何为动态优先数？</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#5-6-静态优先数如何确定的？譬如：进程所需的资源多（或少），就分配较小（或较多）的静态优先数？"><span class="post-toc-number">1.0.0.6.</span> <span class="post-toc-text">5.6 静态优先数如何确定的？譬如：进程所需的资源多（或少），就分配较小（或较多）的静态优先数？</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#5-7-动态优先数如何确定的？譬如：当使用CPU超过一定时长时，就减少（或增加）的动态优先数？"><span class="post-toc-number">1.0.0.7.</span> <span class="post-toc-text">5.7 动态优先数如何确定的？譬如：当使用CPU超过一定时长时，就减少（或增加）的动态优先数？</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#5-8-试述循环轮转调度的概念和其优点。"><span class="post-toc-number">1.0.0.8.</span> <span class="post-toc-text">5.8 试述循环轮转调度的概念和其优点。</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#5-9-Linux创建子进程时，其COUNTER值为什么只继承父进程的一半，原因何在？"><span class="post-toc-number">1.0.0.9.</span> <span class="post-toc-text">5.9 Linux创建子进程时，其COUNTER值为什么只继承父进程的一半，原因何在？</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#5-10-描述Linux（以早期的0-11内核为参考）两个进程A-B切换的基本过程。"><span class="post-toc-number">1.0.0.10.</span> <span class="post-toc-text">5.10 描述Linux（以早期的0.11内核为参考）两个进程A,B切换的基本过程。</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#5-11-描述Linux（以早期的0-11内核为参考）中普通进程的调度过程。"><span class="post-toc-number">1.0.0.11.</span> <span class="post-toc-text">5.11 描述Linux（以早期的0.11内核为参考）中普通进程的调度过程。</span></a></li></ol></li></ol></li></ol></li></ol>
            </nav>
            <div class="toc-bar"><div>
        </aside>
    
</article>

    <div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        我们一起来让这个世界有趣一点
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/img/reward-wechat.jpg" alt="打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <input id="rewardToggle" type="checkbox" class="reward-toggle-check"
                data-wechat="/img/reward-wechat.jpg" data-alipay="/img/reward-alipay.jpg">
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-label"></span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>

    

</div>

    </main>
    <footer class="footer ">
    
    <div class="top">
        
            <p>
    <span>Links：</span>
    
    <span class="blogroll-item">
        <a href="https://www.lujingtao.com" target="_blank">HOME</a>
    </span>
    
</p>

        
    </div>
    
    <div class="bottom">
        <p>
            <span>
                qk6665 &copy; 2020
            </span>
        		
           	
            
            
            
            

            
                
<span class="site-uv" title="总访客量">
    <i class="icon icon-user"></i>
    <i class="busuanzi-value" id="busuanzi_value_site_uv"></i>
</span>


<span class="site-pv" title="总访问量">
    <i class="icon icon-eye"></i>
    <i class="busuanzi-value" id="busuanzi_value_site_pv"></i>
</span>

            
        </p>
    </div>
</footer>

    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://yoursite.com/2020/03/17/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E5%85%AD-%E8%BF%9B%E7%A8%8B%E8%B0%83%E5%BA%A6/&title=《操作系统课程学习笔记六-进程调度》 — welcome to qk6665'blog&pic=http://yoursite.com/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://yoursite.com/2020/03/17/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E5%85%AD-%E8%BF%9B%E7%A8%8B%E8%B0%83%E5%BA%A6/&title=《操作系统课程学习笔记六-进程调度》 — welcome to qk6665'blog&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAT4AAAE+CAAAAAAxUyPsAAAFN0lEQVR42u3d0WojRxQEUP//TyeQpwWvrKq6oyUkR09GsTTdZwxbXXcgX1/x669/Xr/+/Os739///vr+Pa+++dXV288ma3j1Ow+/8OHDhw8fvsO2k238/Ds/v//q6sk3/EyT3Pj2s/jw4cOHD9/Gl4eVPI60EMnNyG9e8sqv8vJ9fPjw4cOH72N8CVASiZ4qGvKrt4UFPnz48OHD92/gy2NHcflDN96Goa3Qx4cPHz58+D7B99Shui67H7pVSTzKr/WRWQc+fPjw4cN3eEDtv/3zwy98+PDhw4fvA0Pl9v3LiD15yCwfPIwa+PDhw4cP36LxZnj88/uXkfaWs9obuVX5xWrx4cOHDx++mC+/fLKZJAQki9tq8aSmb29JFFnw4cOHDx++iS8/kLc0eUhqg9Gzo/f8DyVqXPDhw4cPH74XfO1B+v5o16VSf3ZyncedqKbHhw8fPnz4Yr5tmN0WB21c2MLTpQ4Ypxz48OHDhw/fNQNE/4Qn3O0o/X6T2kC23U58+PDhw4ev5duGyltYuQwDtpKifRQgGQO8aVzw4cOHDx++A18bCO7EebD4XGwqCgV8+PDhw4dvnwsXI+rtyH0POsmq7uVCG3Hw4cOHDx++nK8t0Ntj+SWytOPtJLK0iG++DR8+fPjw4TvwbeGj3cB9QJ58WxuwxtCGDx8+fPjwTef97R/4fMSeE+dLb8cG9z+RN8NyfPjw4cOHL3inLQVy7o2gDSj5Lclvdh6n8OHDhw8fvpbvqVIg+WxUf59H2lsd0EK/RMSHDx8+fPjOlcFTgaNl2gqCrdZPVoIPHz58+PA9y9cuKN98Xk+03G3caQcDY9bDhw8fPnz4XqwnX3QOuo3Jt1CScGyfOo3J8eHDhw8fvh/5LiPzDbcNH8l/vT9OV5cU+PDhw4cP34Fvq9qfQryP4ce+ZCpH8OHDhw8fvgvfz8vNA0RyaL8EpvYb2mF5HZjw4cOHDx++M18eSi6j8aQ42KqENiptV//aNoAPHz58+P73fHn9vR3FL6X8hTv51FMP3uHDhw8fPnw5X7u49pLbYHurAO7jhLEywIcPHz58+Ka2+bL5PKwkR/p2q5cgkoeV3+wOHz58+PDhm/jaTW5H+vsx/v7oWztWf7NyfPjw4cOHr+TbhtmXUuA+jP9cEGkR8eHDhw8fvpYvmqKXD6glAWgr3FumbbhehCd8+PDhw4fvwJfU3E8d+NsRezsGaAfw7acKb3z48OHDh+/RcfXl0bT77cljU7uS6Fr48OHDhw/f3myf/vfAbR3fFuuPbfLwp/Bmp/jw4cOHD1/A9zNK/shXu8T2YbI/8wjaKazgw4cPHz58D7XN+Zc+VbVvrJcx+Vbi48OHDx8+fC3fpSBIFnfha8v07SG2vFN5GX3w4cOHDx++A98GlI+it0H4VnO0V9+48eHDhw8fvpYvX8RW1m9h4h5iLsGlFsCHDx8+fPiCvTy1pS2abIvOC/22aKiLDHz48OHDh2/iawfe20Ng7aK3Ufo2FM+vWNwZfPjw4cOHrzxIt7j3I/0ljnziN9+g48OHDx8+fMvpfowL28g5X2gbmLaBfb7HEyI+fPjw4cMXx5c3hfVhKe1wffs5gW4LlHoCjw8fPnz48JWj6/yS2+H/z9f0l1HBb4ILPnz48OHD9wG+nGz7972NRC3lFoneoOPDhw8fPnwf5tsO7W28eGoNl0fQohCGDx8+fPjwTXzt4f8y5H5qUP1A1V5+/292gQ8fPnz48JV8W1GeH9rbrX5Nr22FdTWPDx8+fPjw7Xx/A+HbRYzyTaF3AAAAAElFTkSuQmCC" alt="微信分享二维码">
</div>


    
    <!-- main-js -->
<script type="text/javascript" src="//cdn.bootcss.com/jquery/2.1.0/jquery.min.js"></script>
<script type="text/javascript" src="/js/plugins/fastclick.js?v=1.4.4"></script>
<script type="text/javascript" src="/js/plugins/ios-orientationchange-fix.js?v=1.4.4"></script>
<script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.2/dist/jquery.fancybox.min.js"></script>

<script type="text/javascript" src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>

<script type="text/javascript" src="/js/method.js?v=1.4.4"></script>
<script type="text/javascript" src="/js/blog.js?v=1.4.4"></script>

<!-- third-party -->






<script type="text/javascript" src="/js/plugins/local_search.js?v=1.4.4"></script>
<script type="text/javascript">
	var search_path = "search.xml";
	if (search_path.length === 0) {
		search_path = "search.xml";
	}
	var path = "/" + search_path;
	searchFunc(path, "local-search-input", "local-search-result");
</script>



<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>



    
    





    <!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
            processEscapes: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>







    
</body>
</html>
